# Implémentation d'un agent Revisor avec LangChain et LangGraph

Dans cette section, nous allons implémenter un agent Revisor (réviseur) qui améliorera les réponses générées par notre système. Contrairement aux étapes précédentes qui pouvaient être complexes, l'implémentation de cet agent est relativement simple car nous disposons déjà de l'infrastructure nécessaire.

# Implementation of a Revisor agent with LangChain and LangGraph

*In this section, we will implement a Revisor agent that will improve the responses generated by our system. Unlike previous steps that might have been complex, implementing this agent is relatively simple as we already have the necessary infrastructure in place.*

---

# Fonctionnement de l'agent Revisor

L'agent Revisor prend en charge la dernière réponse générée, utilise la critique qui en a été faite pour la réviser, puis produit une version améliorée de l'article. Son rôle est essentiel dans le processus d'amélioration continue de nos réponses.

# How the Revisor agent works

*The Revisor agent takes the last generated response, uses the critique that was made of it to revise it, and then produces an improved version of the article. Its role is essential in the continuous improvement process of our responses.*

---

# Mise en œuvre technique

Pour commencer, nous ajoutons un nouveau template d'instructions qui guidera notre agent dans sa tâche de révision.

# Technical implementation

*To begin, we add a new instruction template that will guide our agent in its revision task.*

---

# Ajout des instructions de révision

Pour commencer, nous ajoutons un nouveau template d'instructions qui guidera notre agent dans sa tâche de révision :

```python
revise_instructions = """Revise your previous answer using the new information.
    - You should use the previous critique to add important information to your answer.
        - You MUST include numerical citations in your revised answer to ensure it can be verified.
        - Add a "References" section to the bottom of your answer (which does not count towards the word limit). In form of:
            - [1] https://example.com
            - [2] https://example.com
    - You should use the previous critique to remove superfluous information from your answer and make SURE it is not more than 250 words.
"""
```

Ces instructions demandent à l'agent de :
- Utiliser la critique précédente pour ajouter des informations importantes
- Inclure des citations numériques pour permettre la vérification
- Ajouter une section "References" au bas de la réponse (non comptabilisée dans la limite de mots)
- Supprimer les informations superflues pour maintenir la réponse sous 250 mots

# Adding revision instructions

*To start, we add a new instruction template that will guide our agent in its revision task:*

```python
revise_instructions = """Revise your previous answer using the new information.
    - You should use the previous critique to add important information to your answer.
        - You MUST include numerical citations in your revised answer to ensure it can be verified.
        - Add a "References" section to the bottom of your answer (which does not count towards the word limit). In form of:
            - [1] https://example.com
            - [2] https://example.com
    - You should use the previous critique to remove superfluous information from your answer and make SURE it is not more than 250 words.
"""
```

*These instructions ask the agent to:*
- *Use the previous critique to add important information*
- *Include numerical citations to allow verification*
- *Add a "References" section at the bottom of the answer (not counted in the word limit)*
- *Remove superfluous information to keep the answer under 250 words*

---

# Création d'une nouvelle classe pour la réponse révisée

Ensuite, nous créons une nouvelle classe dans `schemas.py` pour structurer notre réponse révisée :

```python
class ReviseAnswer(AnswerQuestion):
    """Revise your original answer to your question."""

    references: List[str] = Field(
        description="Citations motivating your updated answer."
    )
```

Cette classe `ReviseAnswer` hérite de `AnswerQuestion`, ce qui signifie qu'elle conserve tous ses champs (answer, reflection, search_queries) tout en ajoutant un nouveau champ `references`. Ce dernier est une liste de chaînes de caractères qui contiendra les citations des sources utilisées, principalement des URL provenant du moteur de recherche.

# Creating a new class for the revised answer

*Next, we create a new class in `schemas.py` to structure our revised answer:*

```python
class ReviseAnswer(AnswerQuestion):
    """Revise your original answer to your question."""

    references: List[str] = Field(
        description="Citations motivating your updated answer."
    )
```

*This `ReviseAnswer` class inherits from `AnswerQuestion`, which means it retains all its fields (answer, reflection, search_queries) while adding a new field `references`. The latter is a list of strings that will contain citations of the sources used, mainly URLs from the search engine.*

---

# Implémentation de la chaîne de révision

Enfin, nous implémentons la chaîne de révision (revision chain) :

```python
revisor = actor_prompt_template.partial(
    first_instruction=revise_instructions
) | llm.bind_tools(tools=[ReviseAnswer], tool_choice="ReviseAnswer")
```

Cette chaîne utilise notre template de prompt existant (`actor_prompt_template`), remplit l'espace réservé `first_instruction` avec nos instructions de révision, puis dirige le résultat vers notre modèle LLM (GPT-4 Turbo dans cet exemple) en utilisant l'appel de fonction (function calling). Nous fournissons l'outil `ReviseAnswer` et spécifions que c'est celui qui doit être utilisé, ce qui force notre LLM à produire une réponse conforme au schéma défini par la classe `ReviseAnswer`.

# Implementing the revision chain

*Finally, we implement the revision chain:*

```python
revisor = actor_prompt_template.partial(
    first_instruction=revise_instructions
) | llm.bind_tools(tools=[ReviseAnswer], tool_choice="ReviseAnswer")
```

*This chain uses our existing prompt template (`actor_prompt_template`), fills the `first_instruction` placeholder with our revision instructions, and then directs the result to our LLM model (GPT-4 Turbo in this example) using function calling. We provide the `ReviseAnswer` tool and specify that it's the one to be used, which forces our LLM to produce a response that conforms to the schema defined by the `ReviseAnswer` class.*

---

# Flux de travail complet

Dans le nœud de révision (Revisor node), le processus suivant se déroule :
1. Nous prenons les résultats obtenus du moteur de recherche (Tavily) avec les requêtes pertinentes
2. Nous intégrons ces résultats dans notre article existant, accompagnés de la critique déjà générée
3. L'agent révise la réponse en tenant compte de la critique
4. Il intègre les résultats de recherche de Tavily
5. Il cite toutes les ressources utilisées depuis internet

# Complete workflow

*In the revision node (Revisor node), the following process takes place:*
1. *We take the results obtained from the search engine (Tavily) with relevant queries*
2. *We integrate these results into our existing article, along with the critique already generated*
3. *The agent revises the response taking into account the critique*
4. *It integrates the search results from Tavily*
5. *It cites all resources used from the internet*

---

# Prochaines étapes

Dans la suite, nous traiterons l'exécution des outils et la gestion des recherches web avec Tavily pour les sujets pertinents, puis nous intégrerons ces résultats dans notre réponse révisée.

# Next steps

*In the next part, we will handle tool executions and web search management with Tavily for relevant topics, then integrate these results into our revised answer.*

---

# Récapitulatif du code modifié

### Dans chains.py
- Ajout des instructions de révision
- Importation de la classe `ReviseAnswer` depuis schemas.py
- Création de la chaîne de révision

### Dans schemas.py
- Création de la classe `ReviseAnswer` qui hérite de `AnswerQuestion`
- Ajout du champ `references` pour stocker les citations

# Summary of modified code

### *In chains.py*
- *Addition of revision instructions*
- *Importing the `ReviseAnswer` class from schemas.py*
- *Creation of the revision chain*

### *In schemas.py*
- *Creation of the `ReviseAnswer` class that inherits from `AnswerQuestion`*
- *Addition of the `references` field to store citations*

---

# Tableau récapitulatif du lexique important

| Français | Anglais |
|----------|---------|
| agent Revisor | Revisor agent |
| réviseur | revisor |
| chaîne de révision | revision chain |
| instructions de révision | revision instructions |
| nœud de révision | revision node / Revisor node |
| appel de fonction | function calling |
| moteur de recherche | search engine |
| critique | critique |
| modèle LLM | LLM model |
| espace réservé | placeholder |
| template de prompt | prompt template |
| classe | class |
| héritage | inheritance |
| champ | field |
| liste de chaînes de caractères | list of strings |
| citations | citations |