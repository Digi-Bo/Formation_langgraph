# Implémentation d'un agent Revisor avec LangChain et LangGraph

## Introduction

Dans cette section, nous allons implémenter un agent Revisor (réviseur) qui améliorera les réponses générées par notre système. Contrairement aux étapes précédentes qui pouvaient être complexes, l'implémentation de cet agent est relativement simple car nous disposons déjà de l'infrastructure nécessaire.

## Fonctionnement de l'agent Revisor

L'agent Revisor prend en charge la dernière réponse générée, utilise la critique qui en a été faite pour la réviser, puis produit une version améliorée de l'article. Son rôle est essentiel dans le processus d'amélioration continue de nos réponses.

## Mise en œuvre technique

### Ajout des instructions de révision

Pour commencer, nous ajoutons un nouveau template d'instructions qui guidera notre agent dans sa tâche de révision :

```python
revise_instructions = """Revise your previous answer using the new information.
    - You should use the previous critique to add important information to your answer.
        - You MUST include numerical citations in your revised answer to ensure it can be verified.
        - Add a "References" section to the bottom of your answer (which does not count towards the word limit). In form of:
            - [1] https://example.com
            - [2] https://example.com
    - You should use the previous critique to remove superfluous information from your answer and make SURE it is not more than 250 words.
"""
```

Ces instructions demandent à l'agent de :
- Utiliser la critique précédente pour ajouter des informations importantes
- Inclure des citations numériques pour permettre la vérification
- Ajouter une section "References" au bas de la réponse (non comptabilisée dans la limite de mots)
- Supprimer les informations superflues pour maintenir la réponse sous 250 mots

### Création d'une nouvelle classe pour la réponse révisée

Ensuite, nous créons une nouvelle classe dans `schemas.py` pour structurer notre réponse révisée :

```python
class ReviseAnswer(AnswerQuestion):
    """Revise your original answer to your question."""

    references: List[str] = Field(
        description="Citations motivating your updated answer."
    )
```

Cette classe `ReviseAnswer` hérite de `AnswerQuestion`, ce qui signifie qu'elle conserve tous ses champs (answer, reflection, search_queries) tout en ajoutant un nouveau champ `references`. Ce dernier est une liste de chaînes de caractères qui contiendra les citations des sources utilisées, principalement des URL provenant du moteur de recherche.

### Implémentation de la chaîne de révision

Enfin, nous implémentons la chaîne de révision (revision chain) :

```python
revisor = actor_prompt_template.partial(
    first_instruction=revise_instructions
) | llm.bind_tools(tools=[ReviseAnswer], tool_choice="ReviseAnswer")
```

Cette chaîne utilise notre template de prompt existant (`actor_prompt_template`), remplit l'espace réservé `first_instruction` avec nos instructions de révision, puis dirige le résultat vers notre modèle LLM (GPT-4 Turbo dans cet exemple) en utilisant l'appel de fonction (function calling). Nous fournissons l'outil `ReviseAnswer` et spécifions que c'est celui qui doit être utilisé, ce qui force notre LLM à produire une réponse conforme au schéma défini par la classe `ReviseAnswer`.

## Flux de travail complet

Dans le nœud de révision (Revisor node), le processus suivant se déroule :
1. Nous prenons les résultats obtenus du moteur de recherche (Tavily) avec les requêtes pertinentes
2. Nous intégrons ces résultats dans notre article existant, accompagnés de la critique déjà générée
3. L'agent révise la réponse en tenant compte de la critique
4. Il intègre les résultats de recherche de Tavily
5. Il cite toutes les ressources utilisées depuis internet

## Prochaines étapes

Dans la suite, nous traiterons l'exécution des outils et la gestion des recherches web avec Tavily pour les sujets pertinents, puis nous intégrerons ces résultats dans notre réponse révisée.

## Récapitulatif du code modifié

### Dans chains.py
- Ajout des instructions de révision
- Importation de la classe `ReviseAnswer` depuis schemas.py
- Création de la chaîne de révision

### Dans schemas.py
- Création de la classe `ReviseAnswer` qui hérite de `AnswerQuestion`
- Ajout du champ `references` pour stocker les citations